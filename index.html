<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ORIGIN - Address Record Manager (Cloud Connected)</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX transformation in-browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Leaflet Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in-down { animation: fadeInDown 0.3s ease-out forwards; }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .animate-scale-in { animation: scaleIn 0.2s ease-out forwards; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .animate-spin-slow { animation: spin 2s linear infinite; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .bg-grid-pattern { background-image: linear-gradient(#e2e8f0 1px, transparent 1px), linear-gradient(90deg, #e2e8f0 1px, transparent 1px); background-size: 20px 20px; }
        .leaflet-container { font-family: inherit; z-index: 1; }
        .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(4px); }
        .leaflet-tooltip { font-weight: bold; border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        /**
         * ========================================================================
         * ðŸŒ GOOGLE SHEETS DATABASE CONFIGURATION
         * ========================================================================
         * Web App URL: Connects to your Google Sheet with "addresses" and "Settings" sheets.
         */
        const GOOGLE_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbycWgx-6B8N_2VfkVxFjS7oh0q-Vxm6BpS_paQ-yovz-14P7Fvg4zSVG7YWuUHZ3zGtIg/exec";
        /** ===================================================================== */

        // --- UI Icons ---
        const Icon = ({ name, size = 18, className = "" }) => {
            const containerRef = useRef(null);
            useEffect(() => {
                const container = containerRef.current;
                if (!container) return;
                container.innerHTML = '';
                const iconNode = lucide.icons[name];
                if (iconNode) {
                    let svgElement;
                    if (typeof lucide.createElement === 'function') {
                        svgElement = lucide.createElement(iconNode);
                    } else {
                        const temp = document.createElement('i');
                        temp.setAttribute('data-lucide', name);
                        container.appendChild(temp);
                        lucide.createIcons({ root: container, icons: { [name]: iconNode }, attrs: { strokeWidth: 2, width: size, height: size } });
                        return;
                    }
                    if (svgElement) {
                        svgElement.setAttribute('width', size);
                        svgElement.setAttribute('height', size);
                        svgElement.setAttribute('stroke-width', 2);
                        if (className) {
                            const existing = svgElement.getAttribute('class') || '';
                            svgElement.setAttribute('class', (existing + ' ' + className).trim());
                        }
                        container.appendChild(svgElement);
                    }
                }
            }, [name, size, className]);
            return <span ref={containerRef} style={{ display: 'inline-flex', alignItems: 'center' }}></span>;
        };

        // --- Interactive Map Component ---
        const InteractiveMap = ({ settings, onLocationUpdate, initialLocation }) => {
            const mapContainerRef = useRef(null);
            const mapRef = useRef(null);
            const markerRef = useRef(null);

            useEffect(() => {
                if (!mapContainerRef.current || mapRef.current) return;
                const map = L.map(mapContainerRef.current).setView([settings.centerLat, settings.centerLng], 14);
                mapRef.current = map;
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);

                if (settings.enableGeofence) {
                    L.circle([settings.centerLat, settings.centerLng], { color: 'green', fillColor: '#4ade80', fillOpacity: 0.2, radius: settings.radiusKm * 1000 }).addTo(map);
                }

                let initialLat = settings.centerLat;
                let initialLng = settings.centerLng;
                if (initialLocation && initialLocation.includes('query=')) {
                    try {
                        const coords = initialLocation.split('query=')[1].split(',');
                        if (coords.length === 2) {
                            initialLat = parseFloat(coords[0]);
                            initialLng = parseFloat(coords[1]);
                        }
                    } catch(e) {}
                }

                const marker = L.marker([initialLat, initialLng], { draggable: true }).addTo(map);
                markerRef.current = marker;
                map.setView([initialLat, initialLng], 16);

                const update = (lat, lng) => {
                    const link = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
                    onLocationUpdate(lat, lng, link);
                };

                map.on('click', (e) => { marker.setLatLng(e.latlng); update(e.latlng.lat, e.latlng.lng); });
                marker.on('dragend', () => { const pos = marker.getLatLng(); update(pos.lat, pos.lng); });

                window.handleGpsUpdate = (lat, lng) => {
                    const newLatLng = new L.LatLng(lat, lng);
                    marker.setLatLng(newLatLng);
                    map.setView(newLatLng, 18);
                    update(lat, lng);
                };
                setTimeout(() => map.invalidateSize(), 200);

                return () => { if (mapRef.current) { mapRef.current.remove(); mapRef.current = null; delete window.handleGpsUpdate; } };
            }, []);
            return <div ref={mapContainerRef} className="w-full h-full" style={{ zIndex: 0 }}></div>;
        };

        // --- Settings Map Component ---
        const SettingsMap = ({ centerLat, centerLng, onCenterChange, radiusKm }) => {
            const mapContainerRef = useRef(null);
            const mapRef = useRef(null);
            const circleRef = useRef(null);

            useEffect(() => {
                if (!mapContainerRef.current || mapRef.current) return;
                const map = L.map(mapContainerRef.current).setView([centerLat, centerLng], 14);
                mapRef.current = map;
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

                const marker = L.marker([centerLat, centerLng], { draggable: true }).addTo(map);
                marker.bindTooltip("Center Point", { permanent: true, direction: 'top' });

                const circle = L.circle([centerLat, centerLng], { color: 'blue', fillColor: '#3b82f6', fillOpacity: 0.1, radius: radiusKm * 1000 }).addTo(map);
                circleRef.current = circle;

                marker.on('dragend', () => { const pos = marker.getLatLng(); onCenterChange(pos.lat, pos.lng); circle.setLatLng(pos); });
                map.on('click', (e) => { marker.setLatLng(e.latlng); circle.setLatLng(e.latlng); onCenterChange(e.latlng.lat, e.latlng.lng); });
                setTimeout(() => map.invalidateSize(), 200);

                return () => { if (mapRef.current) { mapRef.current.remove(); mapRef.current = null; } };
            }, []);

            useEffect(() => { if(circleRef.current) { circleRef.current.setRadius(radiusKm * 1000); } }, [radiusKm]);
            return <div ref={mapContainerRef} className="absolute inset-0 z-0"></div>;
        };


        /**
         * ========================================================================
         * ðŸ§  MAIN APPLICATION CORE
         * ========================================================================
         */
        const App = () => {
            const [activeTab, setActiveTab] = useState('search');
            const [addresses, setAddresses] = useState([]);
            const [notification, setNotification] = useState(null);
            const [showSettings, setShowSettings] = useState(false);
            const [isOnline, setIsOnline] = useState(navigator.onLine);
            const [deleteId, setDeleteId] = useState(null);
            const [editData, setEditData] = useState(null);
            const [isSyncing, setIsSyncing] = useState(false);

            const defaultSettings = {
                centerLat: 14.4445, centerLng: 120.9939, radiusKm: 5,
                enableGeofence: true, streets: [],
                validZones: ["T.S Cruz Subdivision", "Almanza dos", "Madrigal", "Alabang town Center", "New alabang Village", "Northgate", "Filinvest"]
            };
            const [appSettings, setAppSettings] = useState(defaultSettings);

            useEffect(() => {
                const handleStatusChange = () => setIsOnline(navigator.onLine);
                window.addEventListener('online', handleStatusChange);
                window.addEventListener('offline', handleStatusChange);

                const savedData = localStorage.getItem('address_db_v1');
                if (savedData) setAddresses(JSON.parse(savedData));
                
                const savedSettings = localStorage.getItem('app_settings_v3');
                if (savedSettings) setAppSettings(JSON.parse(savedSettings));

                if (GOOGLE_WEB_APP_URL && isOnline) {
                    syncAllFromCloud();
                }

                return () => {
                    window.removeEventListener('online', handleStatusChange);
                    window.removeEventListener('offline', handleStatusChange);
                };
            }, [isOnline]);

            const syncAllFromCloud = async () => {
                setIsSyncing(true);
                try {
                    // Fetch Settings from "Settings" sheet
                    const settingsRes = await fetch(`${GOOGLE_WEB_APP_URL}?action=getSettings`);
                    const cloudSettings = await settingsRes.json();
                    if (cloudSettings && Object.keys(cloudSettings).length > 0) {
                        setAppSettings(cloudSettings);
                        localStorage.setItem('app_settings_v3', JSON.stringify(cloudSettings));
                    }

                    // Fetch Addresses from "addresses" sheet
                    const addressRes = await fetch(`${GOOGLE_WEB_APP_URL}?action=getAddresses`);
                    const cloudData = await addressRes.json();
                    if (Array.isArray(cloudData)) {
                        setAddresses(cloudData);
                        localStorage.setItem('address_db_v1', JSON.stringify(cloudData));
                    }
                } catch (e) {
                    console.error("Cloud Sync Error:", e);
                } finally {
                    setIsSyncing(false);
                }
            };

            const showNotification = (message, type = 'success') => {
                setNotification({ message, type });
                setTimeout(() => setNotification(null), 3000);
            };

            /**
             * ðŸ“¤ SAVE/UPDATE RECORD
             */
            const handleSave = async (record) => {
                const updatedAddresses = editData 
                    ? addresses.map(a => a.id === record.id ? record : a)
                    : [record, ...addresses];
                
                setAddresses(updatedAddresses);
                localStorage.setItem('address_db_v1', JSON.stringify(updatedAddresses));
                setEditData(null);
                setActiveTab('data');

                if (GOOGLE_WEB_APP_URL && isOnline) {
                    setIsSyncing(true);
                    try {
                        // POST to Google Sheet Web App
                        await fetch(GOOGLE_WEB_APP_URL, {
                            method: 'POST',
                            mode: 'no-cors', // standard for GAS
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ action: 'saveAddress', data: record })
                        });
                        showNotification('Cloud: Sync Sent');
                    } catch (error) {
                        showNotification('Local: Save Complete (Cloud Failed)', 'error');
                    } finally {
                        setIsSyncing(false);
                    }
                } else {
                    showNotification('Saved to Local Storage');
                }
            };

            /**
             * ðŸ—‘ï¸ DELETE RECORD
             */
            const confirmDelete = async () => {
                if (deleteId !== null) {
                    const idToRemove = deleteId;
                    const updated = addresses.filter(a => a.id !== idToRemove);
                    setAddresses(updated);
                    setDeleteId(null);
                    localStorage.setItem('address_db_v1', JSON.stringify(updated));

                    if (GOOGLE_WEB_APP_URL && isOnline) {
                        setIsSyncing(true);
                        try {
                            await fetch(GOOGLE_WEB_APP_URL, {
                                method: 'POST',
                                mode: 'no-cors',
                                body: JSON.stringify({ action: 'deleteAddress', id: idToRemove })
                            });
                            showNotification('Cloud: Delete Request Sent');
                        } catch (error) {
                            showNotification('Local: Removed (Cloud Sync Failed)', 'error');
                        } finally {
                            setIsSyncing(false);
                        }
                    } else {
                        showNotification('Record deleted locally');
                    }
                }
            };

            /**
             * âš™ï¸ UPDATE APP SETTINGS
             */
            const updateSettings = async (newSettings) => {
                setAppSettings(newSettings);
                localStorage.setItem('app_settings_v3', JSON.stringify(newSettings));
                
                if (GOOGLE_WEB_APP_URL && isOnline) {
                    setIsSyncing(true);
                    try {
                        await fetch(GOOGLE_WEB_APP_URL, {
                            method: 'POST',
                            mode: 'no-cors',
                            body: JSON.stringify({ action: 'saveSettings', data: newSettings })
                        });
                        showNotification('Settings sync sent to Cloud');
                    } catch (error) {
                        showNotification('Settings saved locally', 'error');
                    } finally {
                        setIsSyncing(false);
                    }
                }
            };

            const handleEdit = (record) => { setEditData(record); setActiveTab('add'); };
            const cancelEdit = () => { setEditData(null); setActiveTab('search'); };

            const handleExportCSV = () => {
                if (addresses.length === 0) return showNotification('No data to export.', 'error');
                const headers = ["id,address,purok,purokDiv,group,groupDiv,notes,location,createdAt"];
                const csvRows = addresses.map(row => {
                    const escape = (text) => `"${String(text || '').replace(/"/g, '""')}"`;
                    return [row.id, escape(row.address), escape(row.purok), escape(row.purokDiv), row.group, row.groupDiv, escape(row.notes), escape(row.location), escape(row.createdAt)].join(',');
                });
                const blob = new Blob([[headers, ...csvRows].join('\n')], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.setAttribute('download', `address_export_${new Date().toISOString().slice(0,10)}.csv`);
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
            };

            const handleExportJSON = () => {
                if (addresses.length === 0) return showNotification('No data to export.', 'error');
                const blob = new Blob([JSON.stringify(addresses, null, 2)], { type: 'application/json' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.setAttribute('download', `address_export_${new Date().toISOString().slice(0,10)}.json`);
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
            };

            const handleImportData = (importedData) => {
                if (Array.isArray(importedData)) {
                    const merged = [...addresses];
                    let added = 0;
                    importedData.forEach(item => {
                        if (!merged.find(a => a.id === item.id)) {
                            merged.push({ ...item, id: item.id || Date.now().toString() + Math.random() });
                            added++;
                        }
                    });
                    setAddresses(merged);
                    localStorage.setItem('address_db_v1', JSON.stringify(merged));
                    showNotification(`Imported ${added} new records.`);
                }
            };

            return (
                <div className="min-h-screen text-slate-900 font-sans">
                    <header className="bg-blue-700 text-white p-4 shadow-lg sticky top-0 z-20">
                        <div className="max-w-4xl mx-auto flex justify-between items-center">
                            <div className="w-10 flex items-center">
                                {!isOnline ? (
                                    <Icon name="WifiOff" className="text-blue-300 opacity-80" />
                                ) : isSyncing ? (
                                    <div className="flex items-center text-blue-200">
                                        <Icon name="RefreshCw" className="animate-spin-slow" size={20} />
                                    </div>
                                ) : (
                                    <Icon name="Cloud" className="text-blue-300 opacity-80" title="Connected to Google Sheet" />
                                )}
                            </div>
                            <h1 className="text-2xl font-bold tracking-widest text-center">ORIGIN</h1>
                            <button onClick={() => setShowSettings(true)} className="p-2 hover:bg-blue-600 rounded-full transition-colors w-10 flex justify-center">
                                <Icon name="Settings" size={24} />
                            </button>
                        </div>
                    </header>

                    <div className="bg-white shadow-sm border-b border-slate-200 sticky top-16 z-10">
                        <div className="max-w-4xl mx-auto flex">
                            <TabButton active={activeTab === 'search'} onClick={() => setActiveTab('search')} icon="Search" label="Search" />
                            <TabButton active={activeTab === 'add'} onClick={() => setActiveTab('add')} icon="Plus" label={editData ? "Edit" : "Add"} />
                            <TabButton active={activeTab === 'data'} onClick={() => setActiveTab('data')} icon="Database" label="Data" />
                        </div>
                    </div>

                    <main className="max-w-4xl mx-auto p-4 pb-20">
                        {notification && (
                            <div className={`mb-4 p-3 rounded-lg text-white shadow-md animate-fade-in-down ${notification.type === 'error' ? 'bg-red-500' : 'bg-green-600'}`}>
                                {notification.message}
                            </div>
                        )}
                        {activeTab === 'search' && <SearchTab data={addresses} settings={appSettings} />}
                        {activeTab === 'add' && <AddTab onSave={handleSave} onCancel={cancelEdit} isOnline={isOnline} settings={appSettings} initialData={editData} />}
                        {activeTab === 'data' && <DataTab data={addresses} onDelete={setDeleteId} onEdit={handleEdit} />}
                    </main>

                    {showSettings && (
                        <SettingsModal 
                            onClose={() => setShowSettings(false)} 
                            onExportCSV={handleExportCSV} 
                            onExportJSON={handleExportJSON}
                            onImportData={handleImportData}
                            settings={appSettings}
                            onUpdateSettings={updateSettings}
                            isOnline={isOnline}
                        />
                    )}
                    
                    {deleteId !== null && <DeleteModal onCancel={() => setDeleteId(null)} onConfirm={confirmDelete} />}
                </div>
            );
        };

        const TabButton = ({ active, onClick, icon, label }) => (
            <button onClick={onClick} className={`flex-1 flex items-center justify-center py-4 space-x-2 transition-colors duration-200 ${active ? 'text-blue-700 border-b-2 border-blue-700 bg-blue-50' : 'text-slate-500 hover:text-slate-700 hover:bg-slate-50'}`}>
                <Icon name={icon} />
                <span className="font-medium">{label}</span>
            </button>
        );

        const DeleteModal = ({ onCancel, onConfirm }) => (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-30 backdrop-blur-sm p-4 animate-fade-in-down">
                <div className="bg-white rounded-2xl shadow-2xl w-full max-sm p-6 border border-slate-200 text-center animate-scale-in">
                    <div className="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                        <Icon name="Trash2" size={32} />
                    </div>
                    <h3 className="text-xl font-bold text-slate-800 mb-2">Delete Record?</h3>
                    <p className="text-slate-500 text-sm mb-6">Are you sure? This will remove the record from both local storage and the Google Sheet database.</p>
                    <div className="flex space-x-3">
                        <button onClick={onCancel} className="flex-1 py-3 bg-slate-100 text-slate-700 font-bold rounded-xl hover:bg-slate-200 transition-colors">Cancel</button>
                        <button onClick={onConfirm} className="flex-1 py-3 bg-red-500 text-white font-bold rounded-xl hover:bg-red-600 shadow-lg shadow-red-200 transition-colors">Delete</button>
                    </div>
                </div>
            </div>
        );

        /**
         * ðŸ”Ž SEARCH COMPONENT
         */
        const SearchTab = ({ data, settings }) => {
            const [query, setQuery] = useState('');
            const [matches, setMatches] = useState([]);
            const [selectedMatch, setSelectedMatch] = useState(null);
            const [streetZoneStatus, setStreetZoneStatus] = useState(null);

            useEffect(() => {
                setStreetZoneStatus(null);
                setSelectedMatch(null);
                if (!query) { setMatches([]); return; }
                const lowerQuery = query.toLowerCase();
                
                const results = data.filter(item => 
                    item.address.toLowerCase().includes(lowerQuery) || 
                    (item.notes && item.notes.toLowerCase().includes(lowerQuery))
                ).sort((a, b) => {
                    // Sort by how early the query appears, then by the overall string length
                    const aIdx = a.address.toLowerCase().indexOf(lowerQuery);
                    const bIdx = b.address.toLowerCase().indexOf(lowerQuery);
                    if (aIdx === bIdx) return a.address.length - b.address.length;
                    if (aIdx === -1) return 1;
                    if (bIdx === -1) return -1;
                    return aIdx - bIdx;
                });
                setMatches(results);

                const validZones = settings.validZones || [];
                const isInZone = validZones.some(z => lowerQuery.includes(z.toLowerCase()));

                const streetMatch = settings.streets?.find(s => lowerQuery.includes(s.name.toLowerCase()) || s.name.toLowerCase().includes(lowerQuery));
                
                if (streetMatch) {
                    setStreetZoneStatus({ type: 'found', ...streetMatch });
                } else if (results.length === 0) {
                    if (isInZone) {
                        setStreetZoneStatus({ type: 'zone_ok' });
                    } else {
                        setStreetZoneStatus({ type: 'out_of_zone' });
                    }
                }

                if (results.length === 1) setSelectedMatch(results[0]);
            }, [query, data, settings]);

            const display = useMemo(() => {
                if (selectedMatch) return { title: `${selectedMatch.purok}${selectedMatch.purokDiv}-${selectedMatch.group}${selectedMatch.groupDiv}`, sub: `Division Ref`, desc: selectedMatch.address, status: 'record' };
                if (streetZoneStatus?.type === 'found') return { title: `${streetZoneStatus.purok}-${streetZoneStatus.group}`, sub: 'Street Reference', desc: streetZoneStatus.name, status: 'street' };
                if (streetZoneStatus?.type === 'zone_ok' && query.length > 2) return { title: 'ZONE OK', sub: 'Valid Area', desc: 'No exact record, but within limits', status: 'street' };
                if (streetZoneStatus?.type === 'out_of_zone' && query.length > 2) return { title: 'OUT', sub: 'OUT OF ZONING AREA', desc: query, status: 'error' };
                return null;
            }, [selectedMatch, streetZoneStatus, query]);

            return (
                <div className="space-y-6">
                    <div className={`transition-all duration-300 bg-white rounded-2xl shadow-xl p-8 text-center border-4 ${display?.status === 'error' ? 'border-red-100 bg-red-50' : display?.status === 'street' ? 'border-green-100 bg-green-50' : 'border-blue-100'} ${display ? 'opacity-100 scale-100' : 'opacity-50 scale-95 grayscale'}`}>
                        {display ? (
                            <div>
                                <div className={`text-6xl md:text-8xl font-black mb-2 uppercase ${display.status === 'error' ? 'text-red-600' : display.status === 'street' ? 'text-green-600' : 'text-blue-700'}`}>{display.title}</div>
                                <div className={`text-xl font-medium ${display.status === 'error' ? 'text-red-400' : 'text-slate-500'}`}>{display.sub}</div>
                                <div className="mt-2 text-slate-400 italic text-sm">{display.desc}</div>
                            </div>
                        ) : (
                            <div className="py-8"><div className="text-6xl text-slate-200 font-bold">?-?</div><div className="text-slate-400 mt-2">Enter address below</div></div>
                        )}
                    </div>
                    <div className="relative">
                        <input type="text" placeholder="Search address or street..." className="w-full text-lg p-4 pl-12 rounded-xl border-2 border-slate-200 focus:border-blue-500 outline-none" value={query} onChange={(e) => setQuery(e.target.value)} />
                        <div className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"><Icon name="Search" /></div>
                    </div>

                    {query && matches.length > 0 && (
                        <div className="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden mt-4 animate-fade-in-down">
                            <div className="bg-slate-50 p-2 text-xs font-bold text-slate-400 uppercase tracking-wider border-b">
                                Closest Matches ({matches.length})
                            </div>
                            <div className="max-h-64 overflow-y-auto custom-scrollbar">
                                {matches.slice(0, 15).map(m => (
                                    <button 
                                        key={m.id} 
                                        onClick={() => { setQuery(m.address); setSelectedMatch(m); }} 
                                        className="w-full text-left p-3 border-b border-slate-100 last:border-0 hover:bg-blue-50 focus:bg-blue-50 transition-colors flex justify-between items-center"
                                    >
                                        <div className="flex-1 pr-4">
                                            <div className="font-bold text-slate-800">{m.address}</div>
                                            {m.notes && <div className="text-xs text-slate-500 truncate">{m.notes}</div>}
                                        </div>
                                        <div className="text-sm font-mono font-bold text-blue-600 bg-blue-100 px-3 py-1 rounded-md whitespace-nowrap">
                                            {m.purok}{m.purokDiv}-{m.group}{m.groupDiv}
                                        </div>
                                    </button>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        /**
         * âž• ADD / EDIT COMPONENT
         */
        const AddTab = ({ onSave, onCancel, isOnline, settings, initialData }) => {
            const [formData, setFormData] = useState({ address: '', purok: '1', purokDiv: '', group: '1', groupDiv: '', notes: '', location: '' });
            const [enableMap, setEnableMap] = useState(false);
            
            // Array from A to Z for dropdowns
            const alphabet = ['', ...Array.from({length: 26}, (_, i) => String.fromCharCode(65 + i))];
            
            // Zoning logic check
            const showZoneAlert = formData.address.length > 2;
            const isInZone = showZoneAlert && (settings.validZones || []).some(z => formData.address.toLowerCase().includes(z.toLowerCase()));

            useEffect(() => {
                if (initialData) {
                    setFormData(initialData);
                    if (initialData.location) setEnableMap(true);
                }
            }, [initialData]);

            return (
                <form onSubmit={(e) => { 
                    e.preventDefault(); 
                    onSave(initialData ? { ...initialData, ...formData } : { id: Date.now().toString(), ...formData, createdAt: new Date().toISOString() });
                }} className="bg-white rounded-xl shadow-md border border-slate-200 overflow-hidden">
                    <div className="p-6 space-y-6">
                        <div className="space-y-2">
                            <div className="flex justify-between items-end">
                                <label className="block text-sm font-semibold text-slate-700">Address / Location</label>
                                {showZoneAlert && (
                                    <span className={`text-xs font-bold px-2 py-1 rounded-md shadow-sm transition-colors duration-300 ${isInZone ? 'bg-blue-100 text-blue-700 border border-blue-200' : 'bg-red-100 text-red-700 border border-red-200'}`}>
                                        {isInZone ? 'IN ZONING AREA' : 'OUT OF ZONE'}
                                    </span>
                                )}
                            </div>
                            <input type="text" required className="w-full p-3 rounded-lg border focus:ring-2 focus:ring-blue-500 outline-none" placeholder="House #, Street..." value={formData.address} onChange={e => setFormData({...formData, address: e.target.value})} />
                        </div>
                        
                        <div className="grid grid-cols-2 gap-4">
                            <div className="space-y-2">
                                <label className="block text-xs font-bold text-slate-500 uppercase">Purok (1-50)</label>
                                <select className="w-full p-2 border rounded" value={formData.purok} onChange={e => setFormData({...formData, purok: e.target.value})}>
                                    {Array.from({length: 50}, (_, i) => i + 1).map(n => <option key={n} value={n}>{n}</option>)}
                                </select>
                            </div>
                            <div className="space-y-2">
                                <label className="block text-xs font-bold text-slate-500 uppercase">Group (1-50)</label>
                                <select className="w-full p-2 border rounded" value={formData.group} onChange={e => setFormData({...formData, group: e.target.value})}>
                                    {Array.from({length: 50}, (_, i) => i + 1).map(n => <option key={n} value={n}>{n}</option>)}
                                </select>
                            </div>
                        </div>

                        <div className="space-y-2">
                            <label className="block text-sm font-semibold text-slate-700">Division (Optional)</label>
                            <div className="grid grid-cols-2 gap-4">
                                <select className="w-full p-2 border rounded text-center font-bold text-slate-700" value={formData.purokDiv.toUpperCase()} onChange={e => setFormData({...formData, purokDiv: e.target.value.toLowerCase()})}>
                                    {alphabet.map(letter => <option key={`p-${letter}`} value={letter}>{letter || '- None -'}</option>)}
                                </select>
                                <select className="w-full p-2 border rounded text-center font-bold text-slate-700" value={formData.groupDiv.toUpperCase()} onChange={e => setFormData({...formData, groupDiv: e.target.value.toLowerCase()})}>
                                    {alphabet.map(letter => <option key={`g-${letter}`} value={letter}>{letter || '- None -'}</option>)}
                                </select>
                            </div>
                        </div>

                        <textarea className="w-full p-3 rounded-lg border min-h-[80px]" placeholder="Notes (Owner, details, etc.)" value={formData.notes} onChange={e => setFormData({...formData, notes: e.target.value})} />
                        
                        <div className="flex items-center space-x-2">
                            <input type="checkbox" checked={enableMap} onChange={e => setEnableMap(e.target.checked)} id="enableMap" />
                            <label htmlFor="enableMap" className="text-sm font-bold text-slate-600 cursor-pointer">Pin Location on Map</label>
                        </div>

                        {enableMap && isOnline && (
                            <div className="h-[300px] border rounded-lg overflow-hidden bg-slate-100">
                                <InteractiveMap settings={settings} initialLocation={formData.location} onLocationUpdate={(lat, lng, link) => setFormData(prev => ({ ...prev, location: link }))} />
                            </div>
                        )}
                    </div>
                    <div className="bg-slate-50 p-4 border-t flex justify-end space-x-3">
                        <button type="button" onClick={onCancel} className="px-6 py-2 rounded-lg hover:bg-slate-200 text-slate-600">Cancel</button>
                        <button type="submit" className="px-8 py-2 rounded-lg bg-blue-600 text-white font-bold hover:bg-blue-700 shadow-lg">
                            {initialData ? "Update Record" : "Save to Cloud"}
                        </button>
                    </div>
                </form>
            );
        };

        /**
         * ðŸ“Š DATA TABLE COMPONENT
         */
        const DataTab = ({ data, onDelete, onEdit }) => {
            return (
                <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
                    <div className="overflow-x-auto">
                        <table className="w-full text-left text-sm min-w-[500px]">
                            <thead className="bg-slate-50 text-xs font-bold text-slate-500 uppercase border-b">
                                <tr>
                                    <th className="p-4">Address</th>
                                    <th className="p-4 text-center">Purok-Grp</th>
                                    <th className="p-4 text-center">Pin</th>
                                    <th className="p-4 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y">
                                {data.map(r => (
                                    <tr key={r.id} className="hover:bg-slate-50">
                                        <td className="p-4">
                                            <div className="font-semibold text-slate-800">{r.address}</div>
                                            <div className="text-xs text-slate-400 italic">{r.notes}</div>
                                        </td>
                                        <td className="p-4 text-center">
                                            <span className="font-mono font-bold text-blue-700 uppercase">{r.purok}{r.purokDiv}-{r.group}{r.groupDiv}</span>
                                        </td>
                                        <td className="p-4 text-center">
                                            {r.location ? <a href={r.location} target="_blank" className="text-blue-500"><Icon name="MapPin" size={18}/></a> : <span className="text-slate-200">-</span>}
                                        </td>
                                        <td className="p-4 text-right space-x-2">
                                            <button onClick={() => onEdit(r)} className="text-slate-400 hover:text-blue-600 p-1"><Icon name="Edit" size={16}/></button>
                                            <button onClick={() => onDelete(r.id)} className="text-slate-400 hover:text-red-600 p-1"><Icon name="Trash2" size={16}/></button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        /**
         * âš™ï¸ SETTINGS COMPONENT
         */
        const SettingsModal = ({ onClose, onExportCSV, onExportJSON, onImportData, settings, onUpdateSettings, isOnline }) => {
            const [tempSettings, setTempSettings] = useState(settings);
            const [activeTab, setActiveTab] = useState('map');
            const [newZone, setNewZone] = useState('');
            const fileInputRef = useRef(null);

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        if (file.name.endsWith('.json')) {
                            const data = JSON.parse(event.target.result);
                            onImportData(data);
                        } else if (file.name.endsWith('.csv')) {
                            const text = event.target.result;
                            const lines = text.split('\n').filter(l => l.trim() !== '');
                            const headers = lines[0].split(',').map(h => h.trim());
                            const parsed = lines.slice(1).map(line => {
                                const obj = {};
                                let curr = '', inQuotes = false, colIdx = 0;
                                for (let i = 0; i < line.length; i++) {
                                    let char = line[i];
                                    if (char === '"' && line[i+1] === '"') { curr += '"'; i++; }
                                    else if (char === '"') { inQuotes = !inQuotes; }
                                    else if (char === ',' && !inQuotes) { 
                                        obj[headers[colIdx] || colIdx] = curr; 
                                        curr = ''; colIdx++; 
                                    } else { curr += char; }
                                }
                                obj[headers[colIdx] || colIdx] = curr;
                                return obj;
                            });
                            onImportData(parsed);
                        }
                    } catch (err) {
                        alert("Error parsing file.");
                    }
                };
                reader.readAsText(file);
            };

            const addZone = () => {
                if (newZone.trim() && !(tempSettings.validZones || []).includes(newZone.trim())) {
                    setTempSettings({...tempSettings, validZones: [...(tempSettings.validZones || []), newZone.trim()]});
                    setNewZone('');
                }
            };
            
            const removeZone = (z) => {
                setTempSettings({...tempSettings, validZones: (tempSettings.validZones || []).filter(zone => zone !== z)});
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 backdrop-blur-sm p-4 animate-fade-in-down">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md h-[85vh] overflow-hidden flex flex-col">
                        <div className="p-4 border-b flex justify-between items-center bg-slate-50">
                            <h2 className="font-black text-slate-800 tracking-tighter">APP SETTINGS</h2>
                            <button onClick={onClose}><Icon name="X"/></button>
                        </div>
                        
                        <div className="flex border-b bg-slate-100">
                            <button className={`flex-1 py-3 text-sm font-bold transition-colors ${activeTab === 'map' ? 'bg-white text-blue-600 border-b-2 border-blue-600' : 'text-slate-500'}`} onClick={() => setActiveTab('map')}>Map Config</button>
                            <button className={`flex-1 py-3 text-sm font-bold transition-colors ${activeTab === 'zones' ? 'bg-white text-blue-600 border-b-2 border-blue-600' : 'text-slate-500'}`} onClick={() => setActiveTab('zones')}>Zoning Limits</button>
                            <button className={`flex-1 py-3 text-sm font-bold transition-colors ${activeTab === 'data' ? 'bg-white text-blue-600 border-b-2 border-blue-600' : 'text-slate-500'}`} onClick={() => setActiveTab('data')}>Data</button>
                        </div>

                        <div className="p-6 flex-1 overflow-y-auto custom-scrollbar">
                            {activeTab === 'map' && (
                                <div className="space-y-6">
                                    <div className="space-y-2">
                                        <label className="block text-sm font-bold text-slate-700">Geofence Radius (km)</label>
                                        <input type="number" className="w-full p-2 border rounded" value={tempSettings.radiusKm} onChange={e => setTempSettings({...tempSettings, radiusKm: e.target.value})} />
                                    </div>
                                    <div className="h-[250px] border rounded relative">
                                        <SettingsMap 
                                            centerLat={tempSettings.centerLat} 
                                            centerLng={tempSettings.centerLng} 
                                            radiusKm={tempSettings.radiusKm} 
                                            onCenterChange={(lat, lng) => setTempSettings({...tempSettings, centerLat: lat, centerLng: lng})} 
                                        />
                                    </div>
                                </div>
                            )}

                            {activeTab === 'zones' && (
                                <div className="space-y-4">
                                    <p className="text-sm text-slate-500">Define valid areas. Addresses outside these zones will show "OUT OF ZONING AREA".</p>
                                    <div className="flex space-x-2">
                                        <input type="text" className="flex-1 border-2 border-slate-200 rounded-lg p-2 outline-none focus:border-blue-500" placeholder="e.g. Las Pinas" value={newZone} onChange={e => setNewZone(e.target.value)} onKeyPress={e => e.key === 'Enter' && addZone()} />
                                        <button onClick={addZone} className="bg-blue-600 text-white px-4 rounded-lg font-bold hover:bg-blue-700"><Icon name="Plus" size={20}/></button>
                                    </div>
                                    <div className="flex flex-wrap gap-2 mt-4">
                                        {(tempSettings.validZones || []).map(zone => (
                                            <span key={zone} className="bg-blue-50 border border-blue-200 text-blue-700 px-3 py-1.5 rounded-full text-sm font-semibold flex items-center">
                                                {zone} <button onClick={() => removeZone(zone)} className="ml-2 text-blue-400 hover:text-red-500 transition-colors"><Icon name="X" size={14}/></button>
                                            </span>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {activeTab === 'data' && (
                                <div className="space-y-6">
                                    <div>
                                        <h3 className="font-bold text-slate-700 mb-3 text-sm uppercase tracking-wider">Export Backup</h3>
                                        <div className="grid grid-cols-2 gap-3">
                                            <button onClick={onExportCSV} className="w-full py-3 bg-white border-2 border-slate-200 text-slate-700 font-bold rounded-xl flex justify-center items-center hover:bg-slate-50 transition-colors">
                                                <Icon name="Download" className="mr-2" size={18}/> CSV
                                            </button>
                                            <button onClick={onExportJSON} className="w-full py-3 bg-white border-2 border-slate-200 text-slate-700 font-bold rounded-xl flex justify-center items-center hover:bg-slate-50 transition-colors">
                                                <Icon name="Download" className="mr-2" size={18}/> JSON
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div className="pt-4 border-t border-slate-100">
                                        <h3 className="font-bold text-slate-700 mb-3 text-sm uppercase tracking-wider">Import Data</h3>
                                        <input type="file" accept=".csv,.json" ref={fileInputRef} className="hidden" onChange={handleFileUpload} />
                                        <button onClick={() => fileInputRef.current?.click()} className="w-full py-4 bg-green-50 text-green-700 border-2 border-green-200 font-bold rounded-xl flex justify-center items-center hover:bg-green-100 transition-colors">
                                            <Icon name="Upload" className="mr-2"/> Upload CSV / JSON File
                                        </button>
                                        <p className="text-xs text-slate-400 mt-2 text-center">Supported formats: .csv, .json</p>
                                    </div>
                                </div>
                            )}
                        </div>

                        <div className="p-4 border-t bg-slate-50">
                            <button onClick={() => onUpdateSettings(tempSettings)} className="w-full py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg hover:bg-blue-700 transition-colors">
                                Save Settings
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
