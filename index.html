<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ORIGIN - Address Record Manager</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX transformation in-browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Leaflet Map (Interactive OpenStreetMap) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-down {
            animation: fadeInDown 0.3s ease-out forwards;
        }
        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .animate-scale-in {
            animation: scaleIn 0.2s ease-out forwards;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        /* Offline Pattern for Map Placeholder */
        .bg-grid-pattern {
            background-image: linear-gradient(#e2e8f0 1px, transparent 1px), linear-gradient(90deg, #e2e8f0 1px, transparent 1px);
            background-size: 20px 20px;
        }
        /* Leaflet Specifics */
        .leaflet-container {
            font-family: inherit;
            z-index: 1;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(4px);
        }
        .leaflet-tooltip {
            font-weight: bold;
            border: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- FIXED Icon Component ---
        const Icon = ({ name, size = 18, className = "" }) => {
            const containerRef = useRef(null);

            useEffect(() => {
                const container = containerRef.current;
                if (!container) return;
                container.innerHTML = '';
                const iconNode = lucide.icons[name];

                if (iconNode) {
                    let svgElement;
                    if (typeof lucide.createElement === 'function') {
                        svgElement = lucide.createElement(iconNode);
                    } else {
                        const temp = document.createElement('i');
                        temp.setAttribute('data-lucide', name);
                        container.appendChild(temp);
                        lucide.createIcons({
                            root: container,
                            icons: { [name]: iconNode },
                            attrs: { strokeWidth: 2, width: size, height: size }
                        });
                        return;
                    }

                    if (svgElement) {
                        svgElement.setAttribute('width', size);
                        svgElement.setAttribute('height', size);
                        svgElement.setAttribute('stroke-width', 2);
                        if (className) {
                            const existing = svgElement.getAttribute('class') || '';
                            svgElement.setAttribute('class', (existing + ' ' + className).trim());
                        }
                        container.appendChild(svgElement);
                    }
                }
            }, [name, size, className]);

            return <span ref={containerRef} style={{ display: 'inline-flex', alignItems: 'center' }}></span>;
        };

        // --- MAP SUB-COMPONENTS ---

        const InteractiveMap = ({ settings, onLocationUpdate, initialLocation }) => {
            const mapContainerRef = useRef(null);
            const mapRef = useRef(null);
            const markerRef = useRef(null);

            useEffect(() => {
                if (!mapContainerRef.current || mapRef.current) return;

                const map = L.map(mapContainerRef.current).setView([settings.centerLat, settings.centerLng], 14);
                mapRef.current = map;

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap contributors'
                }).addTo(map);

                if (settings.enableGeofence) {
                    L.circle([settings.centerLat, settings.centerLng], {
                        color: 'green',
                        fillColor: '#4ade80',
                        fillOpacity: 0.2,
                        radius: settings.radiusKm * 1000
                    }).addTo(map);
                }

                // If initialLocation is a Google Maps link, try to extract lat/lng
                let initialLat = settings.centerLat;
                let initialLng = settings.centerLng;
                
                if (initialLocation && initialLocation.includes('query=')) {
                    try {
                        const coords = initialLocation.split('query=')[1].split(',');
                        if (coords.length === 2) {
                            initialLat = parseFloat(coords[0]);
                            initialLng = parseFloat(coords[1]);
                        }
                    } catch(e) {}
                }

                const marker = L.marker([initialLat, initialLng], { draggable: true }).addTo(map);
                markerRef.current = marker;
                map.setView([initialLat, initialLng], 16);

                const update = (lat, lng) => {
                    const link = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
                    onLocationUpdate(lat, lng, link);
                };

                map.on('click', (e) => {
                    marker.setLatLng(e.latlng);
                    update(e.latlng.lat, e.latlng.lng);
                });

                marker.on('dragend', (e) => {
                    const pos = marker.getLatLng();
                    update(pos.lat, pos.lng);
                });

                // Initial update call not needed if we are just loading, 
                // but good to sync state if this is a fresh drop.
                // update(initialLat, initialLng);

                window.handleGpsUpdate = (lat, lng) => {
                    const newLatLng = new L.LatLng(lat, lng);
                    marker.setLatLng(newLatLng);
                    map.setView(newLatLng, 18);
                    update(lat, lng);
                };

                setTimeout(() => map.invalidateSize(), 200);

                return () => {
                    if (mapRef.current) {
                        mapRef.current.remove();
                        mapRef.current = null;
                        delete window.handleGpsUpdate;
                    }
                };
            }, []);

            return <div ref={mapContainerRef} className="w-full h-full" style={{ zIndex: 0 }}></div>;
        };

        const SettingsMap = ({ centerLat, centerLng, onCenterChange, radiusKm }) => {
            const mapContainerRef = useRef(null);
            const mapRef = useRef(null);
            const markerRef = useRef(null);
            const circleRef = useRef(null);

            useEffect(() => {
                if (!mapContainerRef.current || mapRef.current) return;

                const map = L.map(mapContainerRef.current).setView([centerLat, centerLng], 14);
                mapRef.current = map;
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OSM' }).addTo(map);

                // Center Marker
                const marker = L.marker([centerLat, centerLng], { draggable: true }).addTo(map);
                markerRef.current = marker;

                marker.bindTooltip("Center Point", { permanent: true, direction: 'top' });

                // Radius Circle
                const circle = L.circle([centerLat, centerLng], {
                    color: 'blue',
                    fillColor: '#3b82f6',
                    fillOpacity: 0.1,
                    radius: radiusKm * 1000
                }).addTo(map);
                circleRef.current = circle;

                marker.on('dragend', (e) => {
                    const pos = marker.getLatLng();
                    onCenterChange(pos.lat, pos.lng);
                    circle.setLatLng(pos);
                });

                map.on('click', (e) => {
                    marker.setLatLng(e.latlng);
                    circle.setLatLng(e.latlng);
                    onCenterChange(e.latlng.lat, e.latlng.lng);
                });

                setTimeout(() => map.invalidateSize(), 200);

                return () => {
                    if (mapRef.current) {
                        mapRef.current.remove();
                        mapRef.current = null;
                    }
                };
            }, []);

            // Update radius if prop changes
            useEffect(() => {
                if(circleRef.current) {
                    circleRef.current.setRadius(radiusKm * 1000);
                }
            }, [radiusKm]);

            return <div ref={mapContainerRef} className="absolute inset-0 z-0"></div>;
        };


        const App = () => {
            const [activeTab, setActiveTab] = useState('search');
            const [addresses, setAddresses] = useState([]);
            const [notification, setNotification] = useState(null);
            const [showSettings, setShowSettings] = useState(false);
            const [isOnline, setIsOnline] = useState(navigator.onLine);
            const [deleteId, setDeleteId] = useState(null);
            const [editData, setEditData] = useState(null); // Data being edited

            // Default Settings
            const [appSettings, setAppSettings] = useState({
                centerLat: 14.4445, 
                centerLng: 120.9939,
                radiusKm: 5,
                allowedZones: ["Las Pinas", "Alabang", "Madrigal", "T.S Cruz", "BF Homes", "Pilar Village"],
                enableGeofence: true,
                streets: [] // Array of { id, name, purok, group }
            });

            // Initialize Data from Embedded Script or LocalStorage
            useEffect(() => {
                const handleStatusChange = () => setIsOnline(navigator.onLine);
                window.addEventListener('online', handleStatusChange);
                window.addEventListener('offline', handleStatusChange);
                
                // 1. Check for Embedded Data (from "Save as HTML")
                const embeddedScript = document.getElementById('embedded-db');
                let initialData = [];
                let loadedFromEmbedded = false;

                if (embeddedScript && embeddedScript.textContent.trim() !== "[]" && embeddedScript.textContent.trim() !== "") {
                    try {
                        initialData = JSON.parse(embeddedScript.textContent);
                        loadedFromEmbedded = true;
                    } catch (e) {
                        console.error("Failed to parse embedded DB", e);
                    }
                }

                // 2. If no embedded data, check LocalStorage for Data
                if (!loadedFromEmbedded) {
                    const savedData = localStorage.getItem('address_db_v1');
                    if (savedData) {
                        try { 
                            initialData = JSON.parse(savedData); 
                        } catch (e) { 
                            console.error("Failed to load local storage", e); 
                        }
                    }
                }

                setAddresses(initialData);

                // 3. Load Settings
                const savedSettings = localStorage.getItem('app_settings_v3');
                if (savedSettings) {
                    try {
                        setAppSettings(JSON.parse(savedSettings));
                    } catch(e) {}
                } else {
                    // Fallback to v2
                    const v2Settings = localStorage.getItem('app_settings_v2');
                    if (v2Settings) {
                        try {
                            const parsed = JSON.parse(v2Settings);
                            setAppSettings({ ...parsed, streets: [] });
                        } catch(e) {}
                    }
                }

                if (loadedFromEmbedded) {
                    showNotification("Loaded data from embedded file.", "success");
                }

                return () => {
                    window.removeEventListener('online', handleStatusChange);
                    window.removeEventListener('offline', handleStatusChange);
                };
            }, []);

            // Save to LocalStorage whenever addresses change
            useEffect(() => {
                localStorage.setItem('address_db_v1', JSON.stringify(addresses));
            }, [addresses]);

            // Save Settings
            const updateSettings = (newSettings) => {
                setAppSettings(newSettings);
                localStorage.setItem('app_settings_v3', JSON.stringify(newSettings));
                showNotification('Settings updated.');
            };

            const showNotification = (message, type = 'success') => {
                setNotification({ message, type });
                setTimeout(() => setNotification(null), 3000);
            };

            const handleSave = (record) => {
                if (editData) {
                    // Update Existing Record
                    setAddresses(addresses.map(a => a.id === record.id ? record : a));
                    showNotification('Address updated successfully!');
                    setEditData(null);
                } else {
                    // Create New Record
                    setAddresses([record, ...addresses]);
                    showNotification('Address saved successfully!');
                }
                setActiveTab('data');
            };

            const handleEdit = (record) => {
                setEditData(record);
                setActiveTab('add');
            };

            const cancelEdit = () => {
                setEditData(null);
                setActiveTab('search');
            };

            const requestDelete = (id) => setDeleteId(id);

            const confirmDelete = () => {
                if (deleteId !== null) {
                    setAddresses(addresses.filter(a => a.id !== deleteId));
                    showNotification('Record deleted.', 'error');
                    setDeleteId(null);
                }
            };

            // CSV Export
            const handleExportCSV = () => {
                if (addresses.length === 0) {
                    showNotification('No data to export.', 'error');
                    return;
                }
                const headers = ["ID,Address,Purok,PurokDiv,Group,GroupDiv,Notes,Location,CreatedAt"];
                const csvRows = addresses.map(row => {
                    const escape = (text) => `"${String(text || '').replace(/"/g, '""')}"`;
                    return [
                        row.id, escape(row.address), escape(row.purok), escape(row.purokDiv), 
                        row.group, row.groupDiv, escape(row.notes), escape(row.location), escape(row.createdAt)
                    ].join(',');
                });
                const csvContent = [headers, ...csvRows].join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.setAttribute('download', `address_data_${new Date().toISOString().slice(0,10)}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showNotification('Data exported to CSV.');
            };

            // Full Backup Export (JSON)
            const handleExportBackup = () => {
                const backupData = {
                    version: 1,
                    timestamp: new Date().toISOString(),
                    settings: appSettings,
                    addresses: addresses
                };

                const jsonContent = JSON.stringify(backupData, null, 2);
                const blob = new Blob([jsonContent], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.setAttribute('download', `ORIGIN_Backup_${new Date().toISOString().slice(0,10)}.json`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showNotification('Full backup (Data + Settings) exported.');
            };

            const handleImport = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const content = e.target.result;
                        
                        // Check if JSON (Backup File)
                        if (file.name.endsWith('.json') || content.trim().startsWith('{')) {
                            const parsed = JSON.parse(content);
                            
                            let restoredCount = 0;
                            
                            // Restore Addresses
                            if (parsed.addresses && Array.isArray(parsed.addresses)) {
                                setAddresses(parsed.addresses);
                                restoredCount = parsed.addresses.length;
                            } else if (Array.isArray(parsed)) {
                                // Handle legacy straight array dump if manually created
                                setAddresses(parsed);
                                restoredCount = parsed.length;
                            }

                            // Restore Settings
                            if (parsed.settings) {
                                setAppSettings(parsed.settings);
                                localStorage.setItem('app_settings_v3', JSON.stringify(parsed.settings));
                            }

                            showNotification(`Restored backup: ${restoredCount} records & settings.`);
                            setShowSettings(false);
                            
                        } else {
                            // Assume CSV (Legacy/Spreadsheet Import)
                            const lines = content.split('\n');
                            const newAddresses = [];
                            for (let i = 1; i < lines.length; i++) {
                                if (!lines[i].trim()) continue;
                                const rowData = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(item => item.replace(/^"|"$/g, '').replace(/""/g, '"'));
                                if(rowData.length >= 7) {
                                    newAddresses.push({
                                        id: Date.now() + i,
                                        address: rowData[1],
                                        purok: rowData[2],
                                        purokDiv: rowData[3],
                                        group: rowData[4],
                                        groupDiv: rowData[5],
                                        notes: rowData[6],
                                        location: rowData[7] || '',
                                        createdAt: new Date().toISOString()
                                    });
                                }
                            }
                            if (newAddresses.length > 0) {
                                setAddresses(prev => [...newAddresses, ...prev]);
                                showNotification(`Imported ${newAddresses.length} records from CSV.`);
                                setShowSettings(false);
                            }
                        }
                    } catch (err) { 
                        console.error(err);
                        showNotification('Error reading file. Check format.', 'error'); 
                    }
                };
                reader.readAsText(file);
                event.target.value = '';
            };

            const handleClearAll = () => {
                setAddresses([]);
                localStorage.removeItem('address_db_v1');
                showNotification('All data wiped.', 'error');
                setShowSettings(false);
            };

            return (
                <div className="min-h-screen text-slate-900 font-sans">
                    <header className="bg-blue-700 text-white p-4 shadow-lg sticky top-0 z-20">
                        <div className="max-w-4xl mx-auto flex justify-between items-center">
                            <div className="w-10">
                                {!isOnline && <Icon name="WifiOff" className="text-blue-300 opacity-80" />}
                            </div>
                            <h1 className="text-2xl font-bold tracking-widest text-center">ORIGIN</h1>
                            <button onClick={() => setShowSettings(true)} className="p-2 hover:bg-blue-600 rounded-full transition-colors w-10 flex justify-center">
                                <Icon name="Settings" size={24} />
                            </button>
                        </div>
                    </header>

                    <div className="bg-white shadow-sm border-b border-slate-200 sticky top-16 z-10">
                        <div className="max-w-4xl mx-auto flex">
                            <TabButton active={activeTab === 'search'} onClick={() => setActiveTab('search')} icon="Search" label="Search" />
                            <TabButton active={activeTab === 'add'} onClick={() => setActiveTab('add')} icon="Plus" label={editData ? "Edit" : "Add"} />
                            <TabButton active={activeTab === 'data'} onClick={() => setActiveTab('data')} icon="Database" label="Data" />
                        </div>
                    </div>

                    {!isOnline && (
                        <div className="bg-slate-800 text-slate-200 text-center py-2 text-xs font-bold uppercase tracking-wider border-b border-slate-700">
                            Offline Mode Active - Maps Disabled - Database Available
                        </div>
                    )}

                    <main className="max-w-4xl mx-auto p-4 pb-20">
                        {notification && (
                            <div className={`mb-4 p-3 rounded-lg text-white shadow-md animate-fade-in-down ${notification.type === 'error' ? 'bg-red-500' : 'bg-green-600'}`}>
                                {notification.message}
                            </div>
                        )}
                        {activeTab === 'search' && <SearchTab data={addresses} settings={appSettings} />}
                        {activeTab === 'add' && <AddTab onSave={handleSave} onCancel={cancelEdit} isOnline={isOnline} settings={appSettings} initialData={editData} />}
                        {activeTab === 'data' && <DataTab data={addresses} onDelete={requestDelete} onEdit={handleEdit} />}
                    </main>

                    {showSettings && (
                        <SettingsModal 
                            onClose={() => setShowSettings(false)} 
                            onExportCSV={handleExportCSV} 
                            onExportBackup={handleExportBackup}
                            onImport={handleImport} 
                            onClear={handleClearAll} 
                            count={addresses.length}
                            settings={appSettings}
                            onUpdateSettings={updateSettings}
                            isOnline={isOnline}
                        />
                    )}
                    
                    {deleteId !== null && (
                        <DeleteModal 
                            onCancel={() => setDeleteId(null)} 
                            onConfirm={confirmDelete} 
                        />
                    )}
                </div>
            );
        };

        const DeleteModal = ({ onCancel, onConfirm }) => (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-30 backdrop-blur-sm p-4 animate-fade-in-down">
                <div className="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 border border-slate-200 text-center animate-scale-in">
                    <div className="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                        <Icon name="Trash2" size={32} />
                    </div>
                    <h3 className="text-xl font-bold text-slate-800 mb-2">Delete Record?</h3>
                    <p className="text-slate-500 text-sm mb-6">
                        Are you sure you want to remove this address? This action cannot be undone.
                    </p>
                    <div className="flex space-x-3">
                        <button onClick={onCancel} className="flex-1 py-3 bg-slate-100 text-slate-700 font-bold rounded-xl hover:bg-slate-200 transition-colors">
                            Cancel
                        </button>
                        <button onClick={onConfirm} className="flex-1 py-3 bg-red-500 text-white font-bold rounded-xl hover:bg-red-600 shadow-lg shadow-red-200 transition-colors">
                            Delete
                        </button>
                    </div>
                </div>
            </div>
        );

        const TabButton = ({ active, onClick, icon, label }) => (
            <button onClick={onClick} className={`flex-1 flex items-center justify-center py-4 space-x-2 transition-colors duration-200 ${active ? 'text-blue-700 border-b-2 border-blue-700 bg-blue-50' : 'text-slate-500 hover:text-slate-700 hover:bg-slate-50'}`}>
                <Icon name={icon} />
                <span className="font-medium">{label}</span>
            </button>
        );

        const SearchTab = ({ data, settings }) => {
            const [query, setQuery] = useState('');
            const [matches, setMatches] = useState([]);
            const [selectedMatch, setSelectedMatch] = useState(null);
            const [streetZoneStatus, setStreetZoneStatus] = useState(null); // null, {type: 'found', purok, group}, {type: 'not_found'}

            useEffect(() => {
                setStreetZoneStatus(null);
                setSelectedMatch(null);

                if (!query) { setMatches([]); return; }
                const lowerQuery = query.toLowerCase();
                
                // 1. Search History Data
                const results = data.filter(item => item.address.toLowerCase().includes(lowerQuery) || (item.notes && item.notes.toLowerCase().includes(lowerQuery)));
                setMatches(results);

                // 2. Check for Exact/Best Street Match in Settings
                if (settings.streets && settings.streets.length > 0) {
                    const streetMatch = settings.streets.find(s => lowerQuery.includes(s.name.toLowerCase()) || s.name.toLowerCase().includes(lowerQuery));
                    if (streetMatch) {
                        setStreetZoneStatus({ type: 'found', purok: streetMatch.purok, group: streetMatch.group, name: streetMatch.name });
                    } else if (results.length === 0) {
                        // If no history match and no street match, assume out of zone
                        setStreetZoneStatus({ type: 'not_found' });
                    }
                } else if (results.length === 0) {
                    setStreetZoneStatus({ type: 'not_found' });
                }

                // Auto-select single history match if it's the only one
                if (results.length === 1) setSelectedMatch(results[0]);

            }, [query, data, settings]);

            // Determine Display Logic for Big Box
            const display = useMemo(() => {
                if (selectedMatch) {
                    // Priority 1: User explicitly clicked a history record
                    return {
                        title: `${selectedMatch.purok}-${selectedMatch.group}`,
                        sub: `Div: ${selectedMatch.purokDiv.toUpperCase()} / ${selectedMatch.groupDiv.toUpperCase()}`,
                        desc: selectedMatch.address,
                        status: 'record'
                    };
                }
                
                if (streetZoneStatus?.type === 'found') {
                    // Priority 2: Matches a known street in settings
                    return {
                        title: `${streetZoneStatus.purok}-${streetZoneStatus.group}`,
                        sub: 'Registered Street Zone',
                        desc: streetZoneStatus.name,
                        status: 'street'
                    };
                }

                if (streetZoneStatus?.type === 'not_found' && query.length > 2) {
                    // Priority 3: Not found anywhere
                    return {
                        title: 'OUT OF ZONE',
                        sub: 'No registered street or record matches',
                        desc: query,
                        status: 'error'
                    };
                }

                return null;

            }, [selectedMatch, streetZoneStatus, query]);

            return (
                <div className="space-y-6">
                    <div className={`transition-all duration-300 bg-white rounded-2xl shadow-xl p-8 text-center border-4 ${
                        display?.status === 'error' ? 'border-red-100 bg-red-50' : 
                        display?.status === 'street' ? 'border-green-100 bg-green-50' : 
                        'border-blue-100'
                    } ${display ? 'opacity-100 scale-100' : 'opacity-50 scale-95 grayscale'}`}>
                        
                        <div className={`text-sm uppercase font-semibold mb-2 ${display?.status === 'error' ? 'text-red-400' : 'text-slate-400'}`}>Location Identifier</div>
                        
                        {display ? (
                            <div>
                                <div className={`text-6xl md:text-8xl font-black mb-2 ${
                                    display.status === 'error' ? 'text-red-600' : 
                                    display.status === 'street' ? 'text-green-600' : 
                                    'text-blue-700'
                                }`}>{display.title}</div>
                                <div className={`text-xl font-medium ${display.status === 'error' ? 'text-red-400' : 'text-slate-500'}`}>{display.sub}</div>
                                <div className={`mt-4 inline-block px-4 py-1 rounded-full text-sm font-semibold truncate max-w-full ${
                                    display.status === 'error' ? 'bg-red-100 text-red-800' : 
                                    display.status === 'street' ? 'bg-green-100 text-green-800' : 
                                    'bg-blue-50 text-blue-800'
                                }`}>{display.desc}</div>
                            </div>
                        ) : (
                            <div className="py-8">
                                <div className="text-6xl text-slate-200 font-bold">?-?</div>
                                <div className="text-slate-400 mt-2">Search to locate Purok & Group</div>
                            </div>
                        )}
                    </div>

                    <div className="relative">
                        <input type="text" placeholder="Search address or street..." className="w-full text-lg p-4 pl-12 rounded-xl border-2 border-slate-200 focus:border-blue-500 outline-none shadow-sm" value={query} onChange={(e) => setQuery(e.target.value)} />
                        <div className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"><Icon name="Search" /></div>
                    </div>

                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div className="bg-slate-50 px-4 py-2 border-b text-xs font-semibold text-slate-500 uppercase">Search Results (History)</div>
                        {matches.length === 0 ? <div className="p-8 text-center text-slate-400">{query ? 'No existing records found.' : 'Type to begin.'}</div> : (
                            <ul className="divide-y">
                                {matches.map(record => (
                                    <li key={record.id} onClick={() => setSelectedMatch(record)} className={`p-4 cursor-pointer hover:bg-blue-50 flex justify-between items-center ${selectedMatch?.id === record.id ? 'bg-blue-50 border-l-4 border-blue-500' : ''}`}>
                                        <div>
                                            <div className="font-semibold text-slate-800">{record.address}</div>
                                            <div className="text-xs text-slate-500">{record.notes}</div>
                                        </div>
                                        <div className="text-right flex items-center gap-4">
                                            {record.location && (
                                                <a href={record.location} target="_blank" rel="noopener noreferrer" className="text-blue-500 hover:text-blue-700" onClick={(e) => e.stopPropagation()}>
                                                    <Icon name="Map" size={20} />
                                                </a>
                                            )}
                                            <div>
                                                <div className="text-lg font-bold text-blue-700">{record.purok}-{record.group}</div>
                                                <div className="text-xs text-slate-400">Div {record.purokDiv}/{record.groupDiv}</div>
                                            </div>
                                        </div>
                                    </li>
                                ))}
                            </ul>
                        )}
                    </div>
                </div>
            );
        };

        const AddTab = ({ onSave, onCancel, isOnline, settings, initialData }) => {
            const n50 = Array.from({ length: 50 }, (_, i) => i + 1);
            const aZ = Array.from({ length: 26 }, (_, i) => String.fromCharCode(97 + i));
            const [formData, setFormData] = useState({ address: '', purok: '1', purokDiv: '', group: '1', groupDiv: '', notes: '', location: '' });
            const [enableMap, setEnableMap] = useState(false);
            const [isOutsideZone, setIsOutsideZone] = useState(false);
            const [geoDistance, setGeoDistance] = useState(null);
            
            // Populate form if editing
            useEffect(() => {
                if (initialData) {
                    setFormData({
                        address: initialData.address,
                        purok: initialData.purok,
                        purokDiv: initialData.purokDiv,
                        group: initialData.group,
                        groupDiv: initialData.groupDiv,
                        notes: initialData.notes,
                        location: initialData.location || ''
                    });
                    if (initialData.location) setEnableMap(true);
                } else {
                    setFormData({ address: '', purok: '1', purokDiv: '', group: '1', groupDiv: '', notes: '', location: '' });
                    setEnableMap(false);
                }
            }, [initialData]);

            const calculateDistance = (lat1, lon1, lat2, lon2) => {
                const R = 6371;
                const dLat = (lat2 - lat1) * (Math.PI / 180);
                const dLon = (lon2 - lon1) * (Math.PI / 180);
                const a = 
                    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                    Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                return R * c;
            };

            const validateZone = (address, lat, lng) => {
                let textInvalid = true;
                let geoInvalid = true;

                if (address) {
                    const lowerAddress = address.toLowerCase();
                    const hasMatch = settings.allowedZones.some(zone => lowerAddress.includes(zone.toLowerCase()));
                    if (hasMatch) textInvalid = false;
                }

                if (lat && lng) {
                    if (settings.enableGeofence) {
                        const dist = calculateDistance(settings.centerLat, settings.centerLng, lat, lng);
                        setGeoDistance(dist);
                        if (dist <= settings.radiusKm) geoInvalid = false;
                    } else {
                        geoInvalid = false;
                    }
                } else {
                    geoInvalid = textInvalid; 
                }

                if (enableMap && lat && lng) {
                     setIsOutsideZone(geoInvalid);
                } else {
                    setIsOutsideZone(textInvalid);
                }
            };

            useEffect(() => {
                if (!enableMap || !formData.location) {
                    const timer = setTimeout(() => {
                        validateZone(formData.address, null, null);
                    }, 800);
                    return () => clearTimeout(timer);
                }
            }, [formData.address, enableMap]);

            const handleLocationUpdate = (lat, lng, link) => {
                setFormData(prev => ({ ...prev, location: link }));
                validateZone(formData.address, lat, lng);
            };

            const getGPS = () => {
                if (!navigator.geolocation) {
                    alert("Geolocation is not supported by your browser");
                    return;
                }
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        if (window.handleGpsUpdate) {
                            window.handleGpsUpdate(latitude, longitude);
                        } else {
                             const link = `https://www.google.com/maps/search/?api=1&query=${latitude},${longitude}`;
                             handleLocationUpdate(latitude, longitude, link);
                        }
                    },
                    () => {
                        alert("Unable to retrieve your location");
                    }
                );
            };

            return (
                <form onSubmit={(e) => { 
                    e.preventDefault(); 
                    if(formData.address) {
                        if (initialData) {
                             onSave({ ...initialData, ...formData });
                        } else {
                             onSave({ id: Date.now(), ...formData, createdAt: new Date().toISOString() });
                        }
                    }
                }} className="bg-white rounded-xl shadow-md border border-slate-200 overflow-hidden relative">
                    {initialData && (
                        <div className="bg-blue-600 text-white text-center py-2 text-xs font-bold uppercase tracking-wider">
                            Editing Record Mode
                        </div>
                    )}
                    <div className="p-6 space-y-6">
                        <div className="space-y-2">
                            <label className="block text-sm font-semibold text-slate-700">Enter Address</label>
                            <div className="relative">
                                <input 
                                    list="zone-suggestions"
                                    type="text" 
                                    required 
                                    className={`w-full p-3 pl-10 rounded-lg border focus:ring-2 outline-none transition-all ${isOutsideZone ? 'border-red-300 focus:ring-red-100' : 'focus:ring-blue-500'}`}
                                    placeholder="e.g. Block 22, Lot 4, Las Pinas" 
                                    value={formData.address} 
                                    onChange={e => setFormData({...formData, address: e.target.value})} 
                                />
                                <datalist id="zone-suggestions">
                                    {settings.allowedZones.map((zone, i) => (
                                        <option key={i} value={zone} />
                                    ))}
                                </datalist>
                                <div className={`absolute left-3 top-1/2 -translate-y-1/2 ${isOutsideZone ? 'text-red-400' : 'text-slate-400'}`}>
                                    <Icon name="MapPin" size={20} />
                                </div>
                            </div>
                            <p className="text-[10px] text-slate-400 pl-2">Suggestions based on settings: {settings.allowedZones.slice(0,3).join(", ")}...</p>
                        </div>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div className="bg-blue-50 p-4 rounded-lg space-y-4 border border-blue-100">
                                <h3 className="font-bold text-blue-800 flex items-center"><Icon name="Target" className="mr-2"/> Purok Details</h3>
                                <div className="grid grid-cols-2 gap-2">
                                    <select className="p-2 rounded border" value={formData.purok} onChange={e => setFormData({...formData, purok: e.target.value})}>{n50.map(n => <option key={n} value={n}>{n}</option>)}</select>
                                    <select className="p-2 rounded border" value={formData.purokDiv} onChange={e => setFormData({...formData, purokDiv: e.target.value})}><option value="">None</option>{aZ.map(l => <option key={l} value={l}>{l.toUpperCase()}</option>)}</select>
                                </div>
                            </div>
                            <div className="bg-indigo-50 p-4 rounded-lg space-y-4 border border-indigo-100">
                                <h3 className="font-bold text-indigo-800 flex items-center"><Icon name="Users" className="mr-2"/> Group Details</h3>
                                <div className="grid grid-cols-2 gap-2">
                                    <select className="p-2 rounded border" value={formData.group} onChange={e => setFormData({...formData, group: e.target.value})}>{n50.map(n => <option key={n} value={n}>{n}</option>)}</select>
                                    <select className="p-2 rounded border" value={formData.groupDiv} onChange={e => setFormData({...formData, groupDiv: e.target.value})}><option value="">None</option>{aZ.map(l => <option key={l} value={l}>{l.toUpperCase()}</option>)}</select>
                                </div>
                            </div>
                        </div>
                        
                        <div className="space-y-4">
                            <textarea className="w-full p-3 rounded-lg border focus:ring-2 focus:ring-blue-500 outline-none min-h-[80px]" placeholder="Additional Notes..." value={formData.notes} onChange={e => setFormData({...formData, notes: e.target.value})} />
                            
                            <div className="flex items-center px-1">
                                <label className="flex items-center cursor-pointer group">
                                    <div className="relative">
                                        <input type="checkbox" className="sr-only" checked={enableMap} onChange={e => setEnableMap(e.target.checked)} />
                                        <div className={`w-10 h-6 rounded-full shadow-inner transition-colors ${enableMap ? 'bg-blue-500' : 'bg-slate-300'}`}></div>
                                        <div className={`absolute top-1 left-1 bg-white w-4 h-4 rounded-full shadow transition-transform ${enableMap ? 'translate-x-4' : 'translate-x-0'}`}></div>
                                    </div>
                                    <span className="ml-3 text-sm font-bold text-slate-700 group-hover:text-blue-600 transition-colors">Enable Interactive Map & Geofencing</span>
                                </label>
                            </div>

                            {enableMap && (
                                <div className={`border rounded-xl p-1 transition-all animate-fade-in-down ${isOutsideZone ? 'bg-red-50 border-red-100' : 'bg-white border-slate-200'}`}>
                                    <div className="flex items-center justify-between p-3 bg-white border-b rounded-t-lg">
                                        <div className="flex items-center space-x-2">
                                            <div className={`w-2 h-2 rounded-full ${isOutsideZone ? 'bg-red-500' : 'bg-green-500'}`}></div>
                                            <span className="text-xs font-black uppercase tracking-widest text-slate-500">
                                                {isOnline ? "Interactive Mode" : "Offline Zoning Check"}
                                            </span>
                                        </div>
                                        {isOutsideZone ? (
                                            <div className="text-right">
                                                 <span className="text-[10px] font-black text-red-600 uppercase flex items-center animate-pulse">
                                                    <Icon name="AlertTriangle" size={12} className="mr-1"/> Outside Zone
                                                </span>
                                                {geoDistance && <div className="text-[9px] text-red-400">{geoDistance.toFixed(2)}km from center (Max {settings.radiusKm}km)</div>}
                                            </div>
                                        ) : (
                                            <div className="text-right">
                                                <span className="text-[10px] font-black text-green-600 uppercase flex items-center">
                                                    <Icon name="CheckCircle" size={12} className="mr-1"/> Verified
                                                </span>
                                                {geoDistance && <div className="text-[9px] text-green-500">{geoDistance.toFixed(2)}km from center</div>}
                                            </div>
                                        )}
                                    </div>

                                    <div className="flex flex-col md:flex-row h-[350px]">
                                        {/* Map View */}
                                        <div className="flex-1 relative bg-slate-100 overflow-hidden bg-grid-pattern">
                                            {isOnline ? (
                                                <InteractiveMap 
                                                    settings={settings}
                                                    onLocationUpdate={handleLocationUpdate}
                                                    initialLocation={formData.location}
                                                />
                                            ) : (
                                                <div className="absolute inset-0 flex flex-col items-center justify-center p-8 text-center bg-white/90">
                                                    <div className="mb-4 relative">
                                                        <Icon name="Map" className="text-slate-300" size={64} />
                                                        <div className="absolute -bottom-2 -right-2 bg-slate-700 text-white rounded-full p-1 border-4 border-white">
                                                            <Icon name="WifiOff" size={16} />
                                                        </div>
                                                    </div>
                                                    <h3 className="font-bold text-slate-700 mb-1">Visual Map Unavailable</h3>
                                                    <p className="text-slate-500 text-xs max-w-[200px] mb-4">
                                                        You are currently offline. The visual map cannot load.
                                                    </p>
                                                    <div className="bg-slate-100 p-3 rounded-lg border border-slate-200 w-full max-w-[240px]">
                                                        <div className="text-[10px] uppercase text-slate-400 font-bold mb-1">Text-Based Verification</div>
                                                        <div className={`font-mono text-sm font-bold ${isOutsideZone ? 'text-red-600' : 'text-green-600'}`}>
                                                            {isOutsideZone ? "OUT OF ZONE" : "WITHIN ZONE"}
                                                        </div>
                                                    </div>
                                                </div>
                                            )}
                                        </div>

                                        {/* Precise Pointing Sidebar */}
                                        <div className="w-full md:w-56 bg-white border-l border-slate-100 flex flex-col overflow-hidden">
                                            <div className="p-3 border-b bg-slate-50">
                                                <h4 className="text-[10px] font-black text-slate-400 uppercase tracking-tighter">Tools</h4>
                                            </div>
                                            <div className="flex-1 p-4 space-y-4">
                                                <button 
                                                    type="button"
                                                    onClick={getGPS}
                                                    className="w-full flex items-center justify-center p-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors shadow-sm"
                                                >
                                                    <Icon name="Crosshair" size={16} className="mr-2"/>
                                                    <span className="text-xs font-bold">Get My Location</span>
                                                </button>

                                                <div className="text-xs text-slate-500 leading-relaxed">
                                                    <p className="mb-2"><strong>Instructions:</strong></p>
                                                    <ul className="list-disc pl-4 space-y-1">
                                                        <li>Click anywhere on map to drop pin.</li>
                                                        <li>Drag pin to refine.</li>
                                                        <li>Circle indicates safe zone.</li>
                                                    </ul>
                                                </div>

                                                <div className="mt-4 pt-4 border-t">
                                                    <div className="text-[10px] uppercase text-slate-400 font-bold mb-1">Coordinates</div>
                                                    <div className="bg-slate-50 p-2 rounded border border-slate-100 break-all text-[10px] font-mono text-slate-600">
                                                        {formData.location ? formData.location.split('query=')[1] : 'No pin dropped'}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                    <div className="bg-slate-50 p-4 border-t flex justify-end space-x-3">
                        <button type="button" onClick={onCancel} className="px-6 py-2 rounded-lg hover:bg-slate-200 text-slate-600 transition-all">Cancel</button>
                        <button type="submit" className={`px-8 py-2 rounded-lg text-white font-bold shadow-lg transition-all ${isOutsideZone ? 'bg-red-600 hover:bg-red-700 hover:shadow-red-200' : 'bg-blue-600 hover:bg-blue-700 hover:shadow-blue-200'}`}>
                            {initialData ? "Update Record" : "Save Record"}
                        </button>
                    </div>
                </form>
            );
        };

        const DataTab = ({ data, onDelete, onEdit }) => {
            const [searchText, setSearchText] = useState('');
            const [showFilters, setShowFilters] = useState(false);
            const [filters, setFilters] = useState({ purok: '', purokDiv: '', group: '', groupDiv: '' });
            const n50 = Array.from({ length: 50 }, (_, i) => i + 1);
            const aZ = Array.from({ length: 26 }, (_, i) => String.fromCharCode(97 + i));

            const filtered = data.filter(item => {
                const s = searchText.toLowerCase();
                const mSearch = s === '' || item.address.toLowerCase().includes(s) || (item.notes && item.notes.toLowerCase().includes(s));
                const mP = filters.purok === '' || item.purok == filters.purok;
                const mPD = filters.purokDiv === '' || item.purokDiv === filters.purokDiv;
                const mG = filters.group === '' || item.group == filters.group;
                const mGD = filters.groupDiv === '' || item.groupDiv === filters.groupDiv;
                return mSearch && mP && mPD && mG && mGD;
            });

            return (
                <div className="space-y-4">
                    <div className="bg-white p-4 rounded-xl shadow-sm border space-y-4">
                        <div className="flex gap-2">
                            <div className="flex-1 flex items-center bg-slate-50 px-3 py-2 rounded-lg border">
                                <Icon name="Search" className="text-slate-400 mr-2" />
                                <input type="text" placeholder="Filter current data..." className="flex-1 bg-transparent outline-none text-sm" value={searchText} onChange={e => setSearchText(e.target.value)} />
                            </div>
                            <button onClick={() => setShowFilters(!showFilters)} className={`px-3 py-2 rounded-lg border transition-all ${showFilters ? 'bg-blue-50 text-blue-700 border-blue-200 shadow-inner' : 'hover:bg-slate-50'}`}><Icon name="Filter" /></button>
                        </div>
                        {showFilters && (
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-3 pt-4 border-t animate-fade-in-down">
                                <select className="p-2 text-sm border rounded" value={filters.purok} onChange={e => setFilters({...filters, purok: e.target.value})}><option value="">Purok</option>{n50.map(n => <option key={n} value={n}>{n}</option>)}</select>
                                <select className="p-2 text-sm border rounded" value={filters.purokDiv} onChange={e => setFilters({...filters, purokDiv: e.target.value})}><option value="">P-Div</option>{aZ.map(l => <option key={l} value={l}>{l.toUpperCase()}</option>)}</select>
                                <select className="p-2 text-sm border rounded" value={filters.group} onChange={e => setFilters({...filters, group: e.target.value})}><option value="">Group</option>{n50.map(n => <option key={n} value={n}>{n}</option>)}</select>
                                <select className="p-2 text-sm border rounded" value={filters.groupDiv} onChange={e => setFilters({...filters, groupDiv: e.target.value})}><option value="">G-Div</option>{aZ.map(l => <option key={l} value={l}>{l.toUpperCase()}</option>)}</select>
                            </div>
                        )}
                    </div>
                    <div className="flex justify-between px-2 font-bold text-slate-700"><span>History</span><span className="bg-blue-100 text-blue-700 px-3 rounded-full text-xs py-1">Count: {filtered.length}</span></div>
                    <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="w-full text-left text-sm min-w-[600px]">
                                <thead className="bg-slate-50 text-xs font-bold text-slate-500 uppercase border-b">
                                    <tr><th className="p-4">Address</th><th className="p-4 text-center">P</th><th className="p-4 text-center">PD</th><th className="p-4 text-center">G</th><th className="p-4 text-center">GD</th><th className="p-4 text-center">Pin</th><th className="p-4 text-center">Action</th></tr>
                                </thead>
                                <tbody className="divide-y">
                                    {filtered.map(r => (
                                        <tr key={r.id} className="hover:bg-slate-50 transition-colors">
                                            <td className="p-4">
                                                <div className="font-semibold text-slate-800">{r.address}</div>
                                                <div className="text-[10px] text-slate-400 truncate max-w-xs">{r.notes}</div>
                                            </td>
                                            <td className="p-4 text-center"><span className="bg-blue-100 text-blue-800 px-1 rounded font-mono">{r.purok}</span></td>
                                            <td className="p-4 text-center uppercase font-mono">{r.purokDiv || '-'}</td>
                                            <td className="p-4 text-center"><span className="bg-indigo-100 text-indigo-800 px-1 rounded font-mono">{r.group}</span></td>
                                            <td className="p-4 text-center uppercase font-mono">{r.groupDiv || '-'}</td>
                                            <td className="p-4 text-center">
                                                {r.location ? (
                                                    <a href={r.location} target="_blank" rel="noopener noreferrer" className="text-blue-500 hover:text-blue-700 hover:scale-125 transition-transform inline-block">
                                                        <Icon name="Map" size={20} />
                                                    </a>
                                                ) : <span className="text-slate-200"><Icon name="MapOff" size={18}/></span>}
                                            </td>
                                            <td className="p-4 text-center flex justify-center gap-2">
                                                <button title="Edit Record" onClick={() => onEdit(r)} className="text-slate-300 hover:text-blue-500 hover:scale-110 hover:bg-blue-50 p-2 rounded-full transition-all">
                                                    <Icon name="Edit" size={18}/>
                                                </button>
                                                <button title="Delete Record" onClick={() => onDelete(r.id)} className="text-slate-300 hover:text-red-500 hover:scale-110 hover:bg-red-50 p-2 rounded-full transition-all">
                                                    <Icon name="Trash2" size={18}/>
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                            {filtered.length === 0 && (
                                <div className="p-20 text-center text-slate-400">
                                    <Icon name="Database" size={40} className="mx-auto mb-2 opacity-10" />
                                    No records match your criteria.
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const SettingsModal = ({ onClose, onExportCSV, onExportBackup, onImport, onClear, count, settings, onUpdateSettings, isOnline }) => {
            const [confirm, setConfirm] = useState('');
            const [activeTab, setActiveTab] = useState('data');
            const [tempSettings, setTempSettings] = useState(settings);
            
            // Street State
            const [newStreet, setNewStreet] = useState({ name: '', purok: '1', group: '1' });
            const [editingStreetId, setEditingStreetId] = useState(null);
            
            const n50 = Array.from({ length: 50 }, (_, i) => i + 1);

            const handleZoneChange = (e) => {
                const text = e.target.value;
                const zones = text.split(',').map(z => z.trim()).filter(z => z);
                setTempSettings({...tempSettings, allowedZones: zones});
            };

            const saveSettings = () => {
                onUpdateSettings(tempSettings);
            };

            const handleCenterChange = (lat, lng) => {
                setTempSettings(prev => ({ ...prev, centerLat: lat, centerLng: lng }));
            };

            // Street Management
            const addStreet = () => {
                if(!newStreet.name.trim()) return;
                
                if (editingStreetId) {
                    // Update Existing
                    const updatedStreets = tempSettings.streets.map(s => s.id === editingStreetId ? { ...s, ...newStreet } : s);
                    setTempSettings({ ...tempSettings, streets: updatedStreets });
                    setEditingStreetId(null);
                    setNewStreet({ name: '', purok: '1', group: '1' });
                } else {
                    // Create New
                    const updatedStreets = [...(tempSettings.streets || []), { id: Date.now(), ...newStreet }];
                    setTempSettings({ ...tempSettings, streets: updatedStreets });
                    setNewStreet({ name: '', purok: '1', group: '1' });
                }
            };

            const editStreet = (s) => {
                setNewStreet({ name: s.name, purok: s.purok, group: s.group });
                setEditingStreetId(s.id);
            };

            const cancelStreetEdit = () => {
                setNewStreet({ name: '', purok: '1', group: '1' });
                setEditingStreetId(null);
            };

            const deleteStreet = (id) => {
                const updatedStreets = tempSettings.streets.filter(s => s.id !== id);
                setTempSettings({ ...tempSettings, streets: updatedStreets });
                if (editingStreetId === id) cancelStreetEdit();
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 backdrop-blur-sm p-4 animate-fade-in-down">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md h-[90vh] overflow-hidden flex flex-col border border-slate-200 relative">
                        
                        <div className="flex justify-between items-center border-b p-4">
                            <h2 className="text-xl font-black text-slate-800">APP SETTINGS</h2>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-600"><Icon name="X"/></button>
                        </div>
                        
                        <div className="flex border-b bg-slate-50 overflow-x-auto">
                            <button onClick={() => setActiveTab('data')} className={`flex-1 py-3 px-4 text-sm font-bold whitespace-nowrap ${activeTab === 'data' ? 'text-blue-600 border-b-2 border-blue-600 bg-white' : 'text-slate-500'}`}>Data & Storage</button>
                            <button onClick={() => setActiveTab('map')} className={`flex-1 py-3 px-4 text-sm font-bold whitespace-nowrap ${activeTab === 'map' ? 'text-blue-600 border-b-2 border-blue-600 bg-white' : 'text-slate-500'}`}>Map Config</button>
                            <button onClick={() => setActiveTab('streets')} className={`flex-1 py-3 px-4 text-sm font-bold whitespace-nowrap ${activeTab === 'streets' ? 'text-blue-600 border-b-2 border-blue-600 bg-white' : 'text-slate-500'}`}>Streets</button>
                            <a href="https://gemini.google.com/share/396125bbce1d" target="_blank" rel="noopener noreferrer" className="flex items-center justify-center w-12 border-l border-slate-200 text-slate-400 hover:text-blue-600 hover:bg-white transition-colors" title="External Link">
                                <Icon name="ExternalLink" size={16} />
                            </a>
                        </div>

                        <div className="p-0 flex-1 overflow-y-auto custom-scrollbar bg-slate-50">
                            {activeTab === 'data' && (
                                <div className="space-y-6 p-6">
                                    <div className="bg-blue-50 p-4 rounded-xl border border-blue-100">
                                         <div className="flex items-start">
                                            <Icon name="Database" className="mt-1 mr-3 text-blue-600" />
                                            <div>
                                                <div className="font-bold text-blue-900 text-sm">Data Management</div>
                                                <div className="text-xs text-blue-700 mt-1">
                                                    Manage your local data. Export to backup safely or import previous records.
                                                </div>
                                            </div>
                                         </div>
                                    </div>

                                    <div className="grid grid-cols-2 gap-3">
                                        <button onClick={onExportCSV} className="flex items-center justify-center p-3 border-2 border-slate-100 rounded-xl hover:bg-blue-50 hover:border-blue-200 transition-all text-xs font-bold text-slate-600">
                                            <Icon name="FileText" className="mr-2"/> Export CSV
                                        </button>
                                        
                                        <button onClick={() => document.getElementById('imp').click()} className="flex items-center justify-center p-3 border-2 border-slate-100 rounded-xl hover:bg-indigo-50 hover:border-indigo-200 transition-all text-xs font-bold text-slate-600">
                                            <Icon name="Upload" className="mr-2"/> Import Data
                                        </button>
                                    </div>
                                    <div className="text-center text-[10px] text-slate-400">Import supports both CSV and JSON backup files.</div>
                                    <input id="imp" type="file" className="hidden" accept=".csv,.json" onChange={onImport} />
                                    
                                    <div className="pt-6 border-t mt-6">
                                        <div className="text-xs font-bold text-red-400 uppercase mb-2">Danger Zone</div>
                                        <input type="text" placeholder="Type 'clear data' to confirm" className="w-full p-3 border rounded-xl mb-2 text-sm outline-none focus:border-red-500" onChange={e => setConfirm(e.target.value)} />
                                        <button disabled={confirm !== 'clear data'} onClick={onClear} className={`w-full p-3 rounded-xl text-white font-bold transition-all ${confirm === 'clear data' ? 'bg-red-600 shadow-lg shadow-red-100' : 'bg-slate-200 cursor-not-allowed text-slate-400'}`}>Purge Local Storage</button>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'map' && (
                                <div className="flex flex-col h-full">
                                    <div className="p-4 bg-white border-b shadow-sm z-10 text-xs text-slate-500">
                                        Drag the marker to set the default Center Point for the app.
                                    </div>

                                    {/* Editor Map */}
                                    <div className="flex-1 relative bg-slate-200 overflow-hidden">
                                        <SettingsMap 
                                            centerLat={tempSettings.centerLat}
                                            centerLng={tempSettings.centerLng}
                                            radiusKm={tempSettings.radiusKm}
                                            onCenterChange={handleCenterChange}
                                        />
                                    </div>

                                    {/* Basic Settings */}
                                    <div className="p-4 bg-white border-t space-y-4">
                                        <div>
                                            <label className="block text-[10px] font-bold text-slate-400 uppercase mb-1">Center Coordinates</label>
                                            <div className="grid grid-cols-2 gap-2">
                                                <input type="number" step="0.0001" className="p-2 border rounded w-full text-xs" value={tempSettings.centerLat} onChange={e => setTempSettings({...tempSettings, centerLat: parseFloat(e.target.value)})} placeholder="Lat" />
                                                <input type="number" step="0.0001" className="p-2 border rounded w-full text-xs" value={tempSettings.centerLng} onChange={e => setTempSettings({...tempSettings, centerLng: parseFloat(e.target.value)})} placeholder="Lng" />
                                            </div>
                                        </div>
                                        <div>
                                            <label className="block text-[10px] font-bold text-slate-400 uppercase mb-1">Safe Radius (Km)</label>
                                            <input type="number" step="0.1" className="p-2 border rounded w-full text-xs" value={tempSettings.radiusKm} onChange={e => setTempSettings({...tempSettings, radiusKm: parseFloat(e.target.value)})} placeholder="5" />
                                        </div>
                                        <div>
                                            <label className="block text-[10px] font-bold text-slate-400 uppercase mb-1">Address Suggestions</label>
                                            <textarea className="w-full p-2 border rounded text-xs h-16" defaultValue={tempSettings.allowedZones.join(', ')} onChange={handleZoneChange} />
                                        </div>
                                        <button onClick={saveSettings} className="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-lg shadow-blue-200 transition-all">
                                            Save Map Config
                                        </button>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'streets' && (
                                <div className="p-6 space-y-6">
                                    <div className={`p-4 rounded-xl border transition-colors ${editingStreetId ? 'bg-orange-50 border-orange-200' : 'bg-indigo-50 border-indigo-100'}`}>
                                        <h3 className={`font-bold mb-2 text-sm flex justify-between ${editingStreetId ? 'text-orange-900' : 'text-indigo-900'}`}>
                                            <span>{editingStreetId ? 'Edit Street Details' : 'Add New Street'}</span>
                                            {editingStreetId && <button onClick={cancelStreetEdit} className="text-xs underline">Cancel</button>}
                                        </h3>
                                        <div className="space-y-3">
                                            <input 
                                                type="text" 
                                                placeholder="Street Name (e.g., Acacia Avenue)" 
                                                className="w-full p-2 rounded border text-sm"
                                                value={newStreet.name}
                                                onChange={e => setNewStreet({...newStreet, name: e.target.value})}
                                            />
                                            <div className="flex space-x-2">
                                                <div className="flex-1">
                                                    <label className="text-[10px] uppercase font-bold text-slate-400">Purok</label>
                                                    <select className="w-full p-2 rounded border text-sm" value={newStreet.purok} onChange={e => setNewStreet({...newStreet, purok: e.target.value})}>
                                                        {n50.map(n => <option key={n} value={n}>{n}</option>)}
                                                    </select>
                                                </div>
                                                <div className="flex-1">
                                                    <label className="text-[10px] uppercase font-bold text-slate-400">Group</label>
                                                    <select className="w-full p-2 rounded border text-sm" value={newStreet.group} onChange={e => setNewStreet({...newStreet, group: e.target.value})}>
                                                        {n50.map(n => <option key={n} value={n}>{n}</option>)}
                                                    </select>
                                                </div>
                                            </div>
                                            <button onClick={addStreet} className={`w-full py-2 text-white font-bold rounded-lg text-sm transition-colors ${editingStreetId ? 'bg-orange-500 hover:bg-orange-600' : 'bg-indigo-600 hover:bg-indigo-700'}`}>
                                                {editingStreetId ? 'Update Street' : 'Add to List'}
                                            </button>
                                        </div>
                                    </div>

                                    <div>
                                        <h3 className="font-bold text-slate-700 mb-3 text-sm flex justify-between">
                                            <span>Registered Streets</span>
                                            <span className="bg-slate-100 px-2 rounded-full text-xs py-0.5">{tempSettings.streets ? tempSettings.streets.length : 0}</span>
                                        </h3>
                                        <div className="space-y-2 max-h-[300px] overflow-y-auto">
                                            {(!tempSettings.streets || tempSettings.streets.length === 0) ? (
                                                <div className="text-center text-slate-400 text-xs py-4 border-2 border-dashed rounded-lg">No streets added yet.</div>
                                            ) : (
                                                tempSettings.streets.map(s => (
                                                    <div key={s.id} className={`flex justify-between items-center p-3 bg-white border rounded-lg shadow-sm hover:bg-slate-50 ${editingStreetId === s.id ? 'border-orange-400 ring-2 ring-orange-100' : ''}`}>
                                                        <div>
                                                            <div className="font-bold text-slate-800 text-sm">{s.name}</div>
                                                            <div className="text-xs text-slate-500">Purok {s.purok} - Group {s.group}</div>
                                                        </div>
                                                        <div className="flex space-x-1">
                                                            <button onClick={() => editStreet(s)} className="text-slate-300 hover:text-blue-500 p-2"><Icon name="Edit" size={16}/></button>
                                                            <button onClick={() => deleteStreet(s.id)} className="text-slate-300 hover:text-red-500 p-2"><Icon name="Trash2" size={16}/></button>
                                                        </div>
                                                    </div>
                                                ))
                                            )}
                                        </div>
                                    </div>
                                    <button onClick={saveSettings} className="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-lg shadow-blue-200 transition-all sticky bottom-0">
                                        Save Street List
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
